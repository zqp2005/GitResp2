<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理系统</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .form-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>用户管理系统</h1>

    <!-- 消息提示区域 -->
    <div id="messageArea"></div>

    <!-- 用户表单 -->
    <div class="form-section">
        <h2>用户信息</h2>
        <form id="userForm">
            <input type="hidden" id="userId">
            <div class="form-group">
                <label for="uname">用户名:</label>
                <input type="text" id="uname" required>
            </div>
            <div class="form-group">
                <label for="pwd">密码:</label>
                <input type="text" id="pwd" required>
            </div>
            <div class="form-group">
                <label for="realname">真实姓名:</label>
                <input type="text" id="realname" required>
            </div>
            <div class="form-group">
                <label for="identity">身份:</label>
                <input type="text" id="identity" required>
            </div>
            <button type="submit">保存</button>
            <button type="button" id="cancelBtn">取消</button>
        </form>
    </div>


    <!-- 用户列表 -->
    <div>
        <h2>用户列表</h2>
        <button id="refreshBtn">刷新列表</button>
        <table id="userTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>用户名</th>
                <th>密码</th>
                <th>真实姓名</th>
                <th>身份</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="userTableBody">
            <!-- 用户数据将在这里动态加载 -->
            </tbody>
        </table>

        <!-- 分页控件 -->
        <div id="pagination" style="margin-top: 20px; text-align: center;">
            <button id="firstPage">首页</button>
            <button id="prevPage">上一页</button>
            <span id="pageInfo" style="margin: 0 10px;"></span>
            <button id="nextPage">下一页</button>
            <button id="lastPage">末页</button>
            <div style="margin-top: 10px;">
                <label for="pageSizeSelect">每页显示:</label>
                <select id="pageSizeSelect">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
                <label for="pageNumInput">跳转到:</label>
                <input type="number" id="pageNumInput" min="1" style="width: 60px;">
                <button id="goToPage">GO</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // API基础URL
        const API_BASE_URL = 'http://localhost:8080';

        // 使用对象管理分页状态，避免变量作用域问题
        const paginationState = {
            currentPage: 1,
            pageSize: 10,
            totalPage: 1
        };

        $(document).ready(function() {
            // 页面加载时获取所有用户
            loadUsers();

            // 绑定表单事件
            $('#userForm').on('submit', function(e) {
                e.preventDefault();
                saveUser();
            });

            $('#refreshBtn').on('click', function() {
                loadUsers();
            });

            $('#cancelBtn').on('click', function() {
                clearForm();
            });

            // 分页按钮事件
            $('#firstPage').on('click', function() {
                loadUsers(1, paginationState.pageSize);
            });

            $('#prevPage').on('click', function() {
                if (paginationState.currentPage > 1) {
                    loadUsers(paginationState.currentPage - 1, paginationState.pageSize);
                }
            });

            $('#nextPage').on('click', function() {
                if (paginationState.currentPage < paginationState.totalPage) {
                    loadUsers(paginationState.currentPage + 1, paginationState.pageSize);
                }
            });

            $('#lastPage').on('click', function() {
                loadUsers(paginationState.totalPage, paginationState.pageSize);
            });

            // 每页显示数量变化
            $('#pageSizeSelect').on('change', function() {
                paginationState.pageSize = parseInt($(this).val());
                loadUsers(1, paginationState.pageSize);
            });

            // 跳转到指定页
            $('#goToPage').on('click', function() {
                const pageNum = parseInt($('#pageNumInput').val());
                if (pageNum >= 1 && pageNum <= paginationState.totalPage) {
                    loadUsers(pageNum, paginationState.pageSize);
                } else {
                    showMessage('请输入有效的页码', 'error');
                }
            });
        });

        // 加载用户数据（分页）
        function loadUsers(pageNum = 1, size = 10) {
            $.get(`${API_BASE_URL}/find/list`, {
                pageNum: pageNum,
                pageSize: size
            })
                .done(function(pageInfo) {
                    const tbody = $('#userTableBody');
                    tbody.empty();

                    // 更新分页信息
                    paginationState.currentPage = pageInfo.pageNum;
                    paginationState.pageSize = pageInfo.pageSize;
                    paginationState.totalPage = pageInfo.pages;

                    // 显示用户数据
                    pageInfo.list.forEach(user => {
                        tbody.append(`
                <tr>
                    <td>${user.id}</td>
                    <td>${user.uname}</td>
                    <td>${user.pwd}</td>
                    <td>${user.realname}</td>
                    <td>${user.identity}</td>
                    <td>
                        <button class="btn-warning edit-btn" data-id="${user.id}">编辑</button>
                        <button class="btn-danger delete-btn" data-id="${user.id}">删除</button>
                    </td>
                </tr>
            `);
                    });

                    // 更新分页控件
                    updatePagination(pageInfo);

                    // 重新绑定事件
                    $('.edit-btn').off('click').on('click', function() {
                        const id = $(this).data('id');
                        editUser(id);
                    });

                    $('.delete-btn').off('click').on('click', function() {
                        const id = $(this).data('id');
                        deleteUser(id);
                    });
                })
                .fail(function() {
                    showMessage('加载用户列表失败', 'error');
                });
        }

        // 更新分页控件显示
        function updatePagination(pageInfo) {
            $('#pageInfo').text(`第 ${pageInfo.pageNum} 页，共 ${pageInfo.pages} 页，总计 ${pageInfo.total} 条记录`);

            // 禁用/启用分页按钮
            $('#firstPage').on('click', function () {
                loadUsers(1, paginationState.pageSize);
            });

            $('#prevPage').on('click', function () {
                // 移除条件判断，让后端处理边界情况
                loadUsers(paginationState.currentPage - 1, paginationState.pageSize);
            });

            $('#nextPage').on('click', function () {
                // 移除条件判断，让后端处理边界情况
                loadUsers(paginationState.currentPage + 1, paginationState.pageSize);
            });

            $('#lastPage').on('click', function () {
                loadUsers(paginationState.totalPage, paginationState.pageSize);
            });

            // 编辑用户
            function editUser(id) {
                $.get(`${API_BASE_URL}/findOne/${id}`)
                    .done(function (user) {
                        $('#userId').val(user.id);
                        $('#uname').val(user.uname);
                        $('#pwd').val(user.pwd);
                        $('#realname').val(user.realname);
                        $('#identity').val(user.identity);
                        showMessage('正在编辑用户信息', 'success');
                    })
                    .fail(function () {
                        showMessage('获取用户信息失败', 'error');
                    });
            }

            // 删除用户
            function deleteUser(id) {
                if (confirm('确定要删除这个用户吗？')) {
                    $.ajax({
                        url: `${API_BASE_URL}/delete/${id}`,
                        type: 'DELETE'
                    })
                        .done(function (result) {
                            if (result > 0) {
                                showMessage('用户删除成功', 'success');
                                loadUsers();
                                clearForm();
                            } else {
                                showMessage('用户删除失败', 'error');
                            }
                        })
                        .fail(function () {
                            showMessage('删除用户时发生错误', 'error');
                        });
                }
            }

            // 保存用户（新增或更新）
            function saveUser() {
                const user = {
                    id: $('#userId').val() ? parseInt($('#userId').val()) : null,
                    uname: $('#uname').val(),
                    pwd: $('#pwd').val(),
                    realname: $('#realname').val(),
                    identity: $('#identity').val()
                };

                const isUpdate = user.id !== null;
                const url = isUpdate ? `${API_BASE_URL}/update` : `${API_BASE_URL}/insert`;
                const method = isUpdate ? 'PUT' : 'POST';

                $.ajax({
                    url: url,
                    type: method,
                    contentType: 'application/json',
                    data: JSON.stringify(user)
                })
                    .done(function (result) {
                        if (result > 0) {
                            const action = isUpdate ? '更新' : '添加';
                            showMessage(`用户${action}成功`, 'success');
                            clearForm();
                            loadUsers();
                        } else {
                            showMessage('操作失败', 'error');
                        }
                    })
                    .fail(function () {
                        showMessage('保存用户时发生错误', 'error');
                    });
            }

            // 清空表单
            function clearForm() {
                $('#userForm')[0].reset();
                $('#userId').val('');
            }

            // 显示消息
            function showMessage(message, type) {
                const messageArea = $('#messageArea');
                messageArea.removeClass('success error');
                messageArea.addClass(type);
                messageArea.text(message);

                // 3秒后自动清除消息
                setTimeout(() => {
                    messageArea.empty();
                    messageArea.removeClass('success error');
                }, 3000);
            }
        }
    </script>
</div>
</body>
</html>
